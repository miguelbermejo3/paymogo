rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow write: if false;
    }

    match /beds/{bedId} {
      allow read: if true;
      allow create, delete: if false;

      // Se permite subir "taken" +1 solo si en la misma transacción
      // se crea votes/{auth.uid} apuntando a esta cama.
      allow update: if isSignedIn() &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(["taken"]) &&
        request.resource.data.taken is int &&
        resource.data.taken is int &&
        resource.data.capacity is int &&
        request.resource.data.taken == resource.data.taken + 1 &&
        request.resource.data.taken <= resource.data.capacity &&
        !exists(/databases/$(database)/documents/votes/$(request.auth.uid)) &&
        getAfter(/databases/$(database)/documents/votes/$(request.auth.uid)).data.uid == request.auth.uid &&
        getAfter(/databases/$(database)/documents/votes/$(request.auth.uid)).data.bedId == bedId;
    }

    match /votes/{uid} {
      allow read: if isSignedIn() && uid == request.auth.uid;
      allow update, delete: if false;

      // Un voto por auth uid. Además exige crear userVotes/{userId}
      // en la misma transacción para bloquear voto doble por usuario lógico.
      allow create: if isSignedIn() &&
        uid == request.auth.uid &&
        !exists(/databases/$(database)/documents/votes/$(uid)) &&
        request.resource.data.uid == uid &&
        request.resource.data.userId is string &&
        request.resource.data.userId.size() > 0 &&
        request.resource.data.bedId is string &&
        request.resource.data.bedId.size() > 0 &&
        request.resource.data.keys().hasOnly(["uid", "userId", "userName", "bedId", "createdAt", "group"]) &&
        !exists(/databases/$(database)/documents/userVotes/$(request.resource.data.userId)) &&
        getAfter(/databases/$(database)/documents/userVotes/$(request.resource.data.userId)).data.uid == uid &&
        getAfter(/databases/$(database)/documents/userVotes/$(request.resource.data.userId)).data.userId ==
          request.resource.data.userId &&
        getAfter(/databases/$(database)/documents/userVotes/$(request.resource.data.userId)).data.bedId ==
          request.resource.data.bedId;
    }

    match /userVotes/{userId} {
      allow read: if isSignedIn();
      allow update, delete: if false;

      // Un voto por userId. Debe existir la cama y aumentar taken +1
      // en la misma transacción.
      allow create: if isSignedIn() &&
        !exists(/databases/$(database)/documents/userVotes/$(userId)) &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.userId == userId &&
        request.resource.data.bedId is string &&
        request.resource.data.bedId.size() > 0 &&
        request.resource.data.keys().hasOnly(["uid", "userId", "userName", "bedId", "createdAt", "group"]) &&
        exists(/databases/$(database)/documents/beds/$(request.resource.data.bedId)) &&
        get(/databases/$(database)/documents/beds/$(request.resource.data.bedId)).data.taken <
          get(/databases/$(database)/documents/beds/$(request.resource.data.bedId)).data.capacity &&
        getAfter(/databases/$(database)/documents/beds/$(request.resource.data.bedId)).data.taken ==
          get(/databases/$(database)/documents/beds/$(request.resource.data.bedId)).data.taken + 1;
    }

    match /dayVotes/{userId} {
      allow read: if isSignedIn();
      allow update, delete: if false;

      // Un solo voto de días por userId.
      allow create: if isSignedIn() &&
        !exists(/databases/$(database)/documents/dayVotes/$(userId)) &&
        request.resource.data.uid == request.auth.uid &&
        request.resource.data.userId == userId &&
        request.resource.data.optionId in ["viernes", "sabado", "viernes_sabado"] &&
        request.resource.data.optionLabel is string &&
        request.resource.data.optionLabel.size() > 0 &&
        request.resource.data.keys().hasOnly([
          "uid",
          "userId",
          "userName",
          "optionId",
          "optionLabel",
          "createdAt",
          "group",
        ]);
    }
  }
}
